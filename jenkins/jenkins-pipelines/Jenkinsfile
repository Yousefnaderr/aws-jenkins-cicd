pipeline {
    agent any

    environment {
        AWS_REGION      = 'eu-central-1'
        ECR_REPO        = 'aws-project-app'
        IMAGE_TAG       = "backend-${env.BUILD_NUMBER}"
        APP_DIR         = 'small-backend-project'
        AWS_CREDENTIALS = credentials('aws-credentials')
        PEM_FILE        = '/var/lib/jenkins/aws-key.pem'
        SSH_USER        = 'ubuntu'
        EC2_IP          = '10.0.1.92'
    }

    stages {
        stage('Checkout Code') {
            steps {
                checkout scm
            }
        }

        stage('Install Dependencies') {
            steps {
                dir("${APP_DIR}") {
                    sh '''
                        python3 -m venv venv
                        . venv/bin/activate
                        pip install --upgrade pip
                        pip install -r requirements.txt
                    '''
                }
            }
        }

        stage('Run Tests') {
            steps {
                dir("${APP_DIR}") {
                    sh '''
                        . venv/bin/activate
                        pytest tests/ --maxfail=1 --disable-warnings -q
                    '''
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                dir("${APP_DIR}") {
                    sh '''
                        docker build -t $ECR_REPO:$IMAGE_TAG .
                    '''
                }
            }
        }

        stage('Login & Push to ECR') {
            steps {
                withAWS(credentials: 'aws-credentials', region: "${AWS_REGION}") {
                    sh '''
                        AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
                        ECR_URI="$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPO"

                        # Login to ECR
                        aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_URI

                        # Tag & Push Image
                        docker tag $ECR_REPO:$IMAGE_TAG $ECR_URI:$IMAGE_TAG
                        docker push $ECR_URI:$IMAGE_TAG
                    '''
                }
            }
        }

        stage('Deploy to EC2') {
            steps {
                sh '''
                    echo "ðŸ”— Connecting to EC2 and deploying container..."
                    ssh -o StrictHostKeyChecking=no -i ${PEM_FILE} ${SSH_USER}@${EC2_IP} << EOF
                        set -e
                        AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
                        ECR_URI="$AWS_ACCOUNT_ID.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO}"

                        # Login to ECR on EC2
                        aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin $ECR_URI

                        # Stop old container if exists
                        docker stop backend-app || true
                        docker rm backend-app || true

                        # Pull and run new image
                        docker pull $ECR_URI:${IMAGE_TAG}
                        docker run -d --name backend-app -p 80:5000 $ECR_URI:${IMAGE_TAG}
                    EOF
                '''
            }
        }
    }

    post {
        success {
            echo "Deployment completed successfully and app is running on EC2!"
        }
        failure {
            echo "Build or deployment failed â€” check logs above."
        }
        always {
            cleanWs()
        }
    }
}

